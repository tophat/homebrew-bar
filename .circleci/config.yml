version: 2
jobs:
  audit_and_test:
    docker:
      # - image: circleci/ruby:2.6.0-stretch
      - image: linuxbrew/linuxbrew:1.9.3
    steps:
      - checkout
      - run: sudo apt-get update
      - run: sudo apt-get install build-essential curl file git zlibc zlib1g zlib1g-dev ruby ruby-dev -y
      - run: sudo gem install rdiscount
      - run: brew install ruby@2.0.0-p247
      # - run: sudo adduser --disabled-password --gecos "" tapuser
      - run: 
          command: |
            # sudo login -f tapuser
            # sh -c "$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install.sh)"
            # test -d ~/.linuxbrew && eval $(~/.linuxbrew/bin/brew shellenv)
            # test -d /home/linuxbrew/.linuxbrew && eval $(/home/linuxbrew/.linuxbrew/bin/brew shellenv)
            # test -r ~/.bash_profile && echo "eval \$($(brew --prefix)/bin/brew shellenv)" >>~/.bash_profile
            # echo "eval \$($(brew --prefix)/bin/brew shellenv)" >>~/.profile
            brew audit --new-formula Formula/*.rb
            brew audit --strict --online Formula/*.rb
            brew test Formula/*.rb
      - store_artifacts:
          path: /home/linuxbrew/.linuxbrew/Homebrew/Library/Homebrew/vendor/bundle/ruby/2.3.0/extensions/x86_64-linux/2.3.0-static/rdiscount-2.2.0.1/gem_make.out
          destination: gem_make.out
      - store_artifacts:
          path: /home/linuxbrew/.linuxbrew/Homebrew/Library/Homebrew/vendor/bundle/ruby/2.3.0/extensions/x86_64-linux/2.3.0-static/rdiscount-2.2.0.1/mkmf.log
          destination: mkmf.log
workflows:
  version: 2
  audit_test:
    jobs:
      - audit_and_test